@page "/upload-story"
@inject IWebHostEnvironment Environment

<h3>Create Main Story</h3>

<EditForm Model="Story" OnValidSubmit="SaveStory">
    <InputText @bind-Value="Story.Name" placeholder="Story name" />
    <br />
    <InputNumber @bind-Value="Story.Price" placeholder="Price" />
    <br />
    <InputFile OnChange="SelectImage" accept="image/*" />
    <br />
    <button type="submit">Save Story</button>
</EditForm>

@if (Message != null && Message != "")
{
    <p>@Message</p>
}

@if (Message != null && Message != "")
{
    <p>Cover Image:</p>
    <img src="@Story.CoverPath" alt="Cover" width="200" />
}

@code {
    private MainStory Story = new();
    private IBrowserFile SelectedImage;
    private string Message;

    private void SelectImage(InputFileChangeEventArgs fileInfo)
    {
        SelectedImage = fileInfo.File;
    }

    private async Task SaveStory()
    {
        if (string.IsNullOrWhiteSpace(Story.Name) || SelectedImage == null)
        {
            Message = "Please enter a story name and select an image.";
            return;
        }

        var folder = Path.Combine(Environment.WebRootPath, "story-covers");
        Directory.CreateDirectory(folder);

        var filePath = Path.Combine(folder, SelectedImage.Name);

        using var fs = File.Create(filePath);
        var stream = SelectedImage.OpenReadStream(5 * 1024 * 1024);
        await stream.CopyToAsync(fs);

        Story.CoverPath = "/story-covers/" + SelectedImage.Name;

        Message = $"Story '{Story.Name}' saved successfully.";

        SelectedImage = null;
    }
}

